# Schema regeneration workflow for Terraform provider.
# This workflow regenerates Terraform schemas from backend configuration files.
#
# PREREQUISITES:
# 1. Configure BACKEND_REPO_URL secret with the backend repository URL
# 2. Configure BACKEND_TOKEN secret with access token for the backend repo (if private)
#
# See docs/plans/2026-01-08-provider-refactor-design.md for full refactor plan.

name: Regenerate Schemas

on:
  workflow_dispatch:  # Manual trigger
    inputs:
      connector_type:
        description: 'Connector type to generate (source/destination/all)'
        required: true
        default: 'all'
        type: choice
        options:
          - all
          - source
          - destination
  # Uncomment to enable automatic regeneration:
  # schedule:
  #   - cron: '0 6 * * 1'  # Weekly on Monday at 6 AM UTC

permissions:
  contents: write
  pull-requests: write

jobs:
  regenerate:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - uses: actions/setup-go@3041bf56c941b39c61721a86cd11f3bb1338122a # v5.2.0
        with:
          go-version-file: "go.mod"
          cache: true

      - name: Clone backend repository
        env:
          BACKEND_REPO_URL: ${{ secrets.BACKEND_REPO_URL }}
          BACKEND_TOKEN: ${{ secrets.BACKEND_TOKEN }}
        run: |
          if [ -z "$BACKEND_REPO_URL" ]; then
            echo "‚ùå BACKEND_REPO_URL secret is not configured"
            exit 1
          fi

          # Clone with token if provided
          if [ -n "$BACKEND_TOKEN" ]; then
            git clone --depth 1 "https://${BACKEND_TOKEN}@${BACKEND_REPO_URL#https://}" backend
          else
            git clone --depth 1 "$BACKEND_REPO_URL" backend
          fi

      - name: Build generator
        run: go build -o tfgen ./cmd/tfgen

      - name: Generate schemas
        run: |
          set -e  # Exit on first error
          CONNECTOR_TYPE="${{ github.event.inputs.connector_type || 'all' }}"
          ERRORS=0

          if [ "$CONNECTOR_TYPE" = "all" ] || [ "$CONNECTOR_TYPE" = "source" ]; then
            echo "Generating source schemas..."
            shopt -s nullglob  # Handle empty globs gracefully
            configs=(backend/app/sources/plugins/*/configuration.latest.json)
            if [ ${#configs[@]} -eq 0 ]; then
              echo "‚ö†Ô∏è No source configuration files found"
            else
              for config in "${configs[@]}"; do
                connector=$(basename "$(dirname "$config")")
                echo "  - $connector"
                if ! ./tfgen generate --config "$config" --type source --output internal/generated/; then
                  echo "‚ùå Failed to generate schema for source: $connector"
                  ERRORS=$((ERRORS + 1))
                fi
              done
            fi
          fi

          if [ "$CONNECTOR_TYPE" = "all" ] || [ "$CONNECTOR_TYPE" = "destination" ]; then
            echo "Generating destination schemas..."
            shopt -s nullglob  # Handle empty globs gracefully
            configs=(backend/app/destinations/plugins/*/configuration.latest.json)
            if [ ${#configs[@]} -eq 0 ]; then
              echo "‚ö†Ô∏è No destination configuration files found"
            else
              for config in "${configs[@]}"; do
                connector=$(basename "$(dirname "$config")")
                echo "  - $connector"
                if ! ./tfgen generate --config "$config" --type destination --output internal/generated/; then
                  echo "‚ùå Failed to generate schema for destination: $connector"
                  ERRORS=$((ERRORS + 1))
                fi
              done
            fi
          fi

          if [ $ERRORS -gt 0 ]; then
            echo "‚ùå Schema generation completed with $ERRORS error(s)"
            exit 1
          fi
          echo "‚úÖ Schema generation completed successfully"

      - name: Run tests
        run: go test -v -short ./...

      - name: Check for changes
        id: check_changes
        run: |
          if git diff --exit-code "internal/generated/"; then
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "‚úÖ No schema changes detected"
          else
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "üìù Schema changes detected"
          fi

      - name: Create Pull Request
        if: steps.check_changes.outputs.has_changes == 'true'
        uses: peter-evans/create-pull-request@c5a7806660adbe173f04e3e038b0ccdcd758773c # v6.1.0
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "chore: regenerate Terraform schemas from backend"
          title: "chore: regenerate Terraform schemas"
          body: |
            This PR was automatically generated by the schema regeneration workflow.

            ## Changes
            Updated Terraform schemas based on the latest backend configuration files.

            ## Verification
            - [ ] Review the generated schema changes
            - [ ] Run acceptance tests if needed
            - [ ] Verify documentation is updated
          branch: chore/regenerate-schemas
          delete-branch: true
