## Codebase Patterns
- The `docs/audits/` directory already exists with reference documentation files
- Go build command: `go build ./...` for typechecking
- Branch naming: PRD specifies `ralph/terraform-provider-audit` branch for audit work
- API client files are in `internal/api/`: auth.go (token), client.go (interface + doRequest), source.go, destination.go, etc.
- All API operations use `?secret_returned=true` to get sensitive fields in responses

---

## 2026-01-21 - US-001
- What was implemented:
  - Created `docs/audits/architecture-comparison-report.md` with proper structure
  - Added document header with title, date, auditor info
  - Added Table of Contents with 4 main sections
  - Added empty placeholder sections: Main Branch Architecture, Refactored Architecture, Comparison Matrix, Trade-offs
- Files changed:
  - Created: `docs/audits/architecture-comparison-report.md`
  - Created: `tasks/progress.txt`
- **Learnings for future iterations:**
  - The `docs/audits/` directory already existed with `backend-code-reference.md` and `entity-config-schema-audit.md`
  - These existing docs are useful references for understanding the backend and config schema
---

## 2026-01-21 - US-002
- What was implemented:
  - Documented main branch architecture pattern in `docs/audits/architecture-comparison-report.md`
  - Read 2 representative connectors via git: `postgresql.go` (589 LOC) and `snowflake.go` (503 LOC)
  - Documented manual schemas, inline CRUD, ~400-600 LOC per connector pattern
  - Documented type conversion methods: `model2ConfigMap` and `configMap2Model`
  - Added code examples and summary table
- Files changed:
  - Modified: `docs/audits/architecture-comparison-report.md`
- **Learnings for future iterations:**
  - Main branch connectors can be accessed via `git show main:path/to/file`
  - Each main branch connector is ~400-600 LOC with significant code duplication
  - Key components: Resource model struct, Schema definition, CRUD operations, Type conversion methods
  - Connectors use `helper.GetTfCfgString/Int64/Bool` for type conversion from API response
---

## 2026-01-21 - US-003
- What was implemented:
  - Documented refactored three-layer architecture in `docs/audits/architecture-comparison-report.md`
  - Verified 3 generated files have `// Code generated by tfgen. DO NOT EDIT.` markers
  - Counted 52 total generated schema files (20 sources, 23 destinations, 8 transforms, 1 doc.go)
  - Documented file counts per layer with LOC statistics
  - Created ASCII architecture diagram showing three layers
  - Documented: Generated Schemas layer, Thin Wrappers layer, Shared Base Resource layer
  - Calculated ~53% LOC reduction per connector vs main branch (~235 vs ~500 LOC)
- Files changed:
  - Modified: `docs/audits/architecture-comparison-report.md`
- **Learnings for future iterations:**
  - Three-layer architecture: Generated Schemas → Thin Wrappers → Shared Base Resource
  - `internal/generated/` contains 52 auto-generated files (DO NOT EDIT)
  - `internal/resource/source/*_generated.go` and `internal/resource/destination/*_generated.go` are thin wrappers (~55 LOC each)
  - `internal/resource/connector/base.go` (701 LOC) contains all shared CRUD logic with reflection
  - Wrappers implement `ConnectorConfig` interface with: GetSchema, GetFieldMappings, GetConnectorType, GetConnectorCode, GetResourceName, NewModelInstance
  - Reflection-based marshaling in base.go: `modelToConfigMap()` and `configMapToModel()`
---

## 2026-01-21 - US-004
- What was implemented:
  - Verified wrapper files exist: 20 in `internal/resource/source/`, 22 in `internal/resource/destination/`
  - Verified ConnectorConfig interface implementation in 2 spot-checked files (postgresql_generated.go, snowflake_generated.go)
  - Both wrappers have compile-time interface check: `var _ connector.ConnectorConfig = (*Config)(nil)`
  - Verified `internal/resource/connector/base.go` contains shared CRUD logic (Create/Read/Update/Delete/ImportState)
  - Verified `modelToConfigMap()` and `configMapToModel()` use reflection for generic type conversion
  - Confirmed no business logic in generated files - only Model struct, Schema function, Field mappings
  - Typecheck passed: `go build ./...`
  - Added "Layer Separation Verification" section to audit report
- Files changed:
  - Modified: `docs/audits/architecture-comparison-report.md`
- **Learnings for future iterations:**
  - Wrapper files use compile-time interface compliance check pattern: `var _ Interface = (*Impl)(nil)`
  - base.go CRUD methods: Create (117-226), Read (229-313), Update (316-422), Delete (425-494)
  - Reflection helpers: extractTerraformValue(), setTerraformValue(), getStringField(), setStringField()
  - Generated files contain only: Model struct with tfsdk tags, Schema() function, FieldMappings map
---

## 2026-01-21 - US-005
- What was implemented:
  - Added comprehensive "Comparison Matrix" section to `docs/audits/architecture-comparison-report.md`
  - Created Architecture Comparison Table with 14 aspects compared (LOC, Schema definition, CRUD, Type conversion, etc.)
  - Added Quantitative Comparison table showing ~48% LOC reduction per connector
  - Added Feature Comparison table (sensitive fields, defaults, validators, enum handling, etc.)
  - Added detailed "Trade-offs" section with advantages (6 items) and disadvantages (6 items)
  - Added Risk Assessment table with likelihood, impact, and mitigation strategies
  - Added final Recommendation section with rationale
  - Typecheck passed: `go build ./...`
- Files changed:
  - Modified: `docs/audits/architecture-comparison-report.md`
- **Learnings for future iterations:**
  - Key metrics: ~48% LOC reduction per connector, ~88% reduction in unique code per connector
  - Refactored architecture adds ~500 LOC of shared infrastructure (base.go) but saves ~4,000+ LOC across all connectors
  - Main trade-off: Reflection complexity vs. code duplication reduction
  - Primary mitigations for reflection risks: compile-time interface checks, schema backward compatibility tests, acceptance tests with VCR
---

## 2026-01-21 - US-006
- What was implemented:
  - Added comprehensive "Architectural Decisions" section to `docs/audits/architecture-comparison-report.md`
  - Documented 4 key architectural decisions with full rationale:
    1. Code Generation Approach - using `cmd/tfgen` to generate schemas from backend config
    2. Reflection-Based Marshaling - generic `modelToConfigMap()`/`configMapToModel()` in `base.go`
    3. Thin Wrapper Pattern - ~55 LOC wrapper files implementing `ConnectorConfig` interface
    4. JSON-Based Deprecations/Overrides - `deprecations.json` and `overrides.json` configuration
  - Each decision includes: Context, Decision, Rationale (4+ points), Trade-offs Accepted
  - Added code examples and implementation details
  - Updated Table of Contents with new section
  - Typecheck passed: `go build ./...`
- Files changed:
  - Modified: `docs/audits/architecture-comparison-report.md`
- **Learnings for future iterations:**
  - `deprecations.json` contains 10 deprecated field definitions (9 PostgreSQL source, 1 Snowflake destination)
  - `overrides.json` contains 3 field overrides for complex map types (Snowflake map_string, ClickHouse map_nested, SQL Server map_nested)
  - Generator infrastructure is ~1,500 LOC in `cmd/tfgen/`
  - Key mitigations for reflection risks: compile-time interface checks (`var _ Interface = (*Impl)(nil)`)
---

## 2026-01-21 - US-007
- What was implemented:
  - Added comprehensive "API Client" section to `docs/audits/architecture-comparison-report.md`
  - Documented OAuth2 token exchange function in `internal/api/auth.go` (lines 22-45)
  - Documented Authorization header set in `doRequest()` at `client.go:84-86`
  - Verified `?secret_returned=true` parameter used across all API operations
  - Updated Table of Contents with new section
  - Typecheck passed: `go build ./...`
- Files changed:
  - Modified: `docs/audits/architecture-comparison-report.md`
- **Learnings for future iterations:**
  - API client uses `StreamkapAPI` interface (client.go:15-53) for all operations
  - Token structure: AccessToken, Expires, ExpiresIn, RefreshToken
  - `?secret_returned=true` is used in all CRUD operations for sources, destinations, transforms, and pipelines (15 endpoints total)
  - doRequest() sets Content-Type, Accept, and Authorization headers automatically
  - doRequestWithRetry() wraps doRequest with retry logic for transient errors
---

## 2026-01-21 - US-008
- What was implemented:
  - Verified API `detail` field errors extracted in `client.go:96-110` via `APIErrorResponse` struct
  - Verified `created_from: terraform` injected on all 5 create operations (source, destination, transform, pipeline, tag)
  - Ran API unit tests: `go test -v -short ./internal/api/...` - all 21 tests passed (1.158s)
  - Added "Error Handling" section to audit report documenting error extraction pattern
  - Added "Resource Origin Tracking (created_from)" section with table of all injection points
  - Added "API Unit Test Results" section with detailed test categories and counts
  - Typecheck passed: `go build ./...`
- Files changed:
  - Modified: `docs/audits/architecture-comparison-report.md`
- **Learnings for future iterations:**
  - `APIErrorResponse.Detail` is extracted for all non-2xx responses in `doRequest()`
  - `created_from` uses `constants.TERRAFORM` constant defined in the constants package
  - API tests cover Source CRUD (9 tests), Authentication (4 tests), and Retry Logic (8 tests including 16 sub-tests)
  - `TestCreateSource_Success` specifically verifies `created_from: terraform` in request body
---

## 2026-01-21 - US-009
- What was implemented:
  - Read `internal/api/retry.go` (121 lines)
  - Verified retry for status codes 502, 503, 504 in `gatewayPatterns` (line 31)
  - Verified exponential backoff implementation via `delay = min(delay*2, cfg.MaxDelay)` (line 116)
  - Added comprehensive "Retry Logic" subsection to audit report under API Client section
  - Documented: IsRetryableError() with 4 error categories, RetryWithBackoff() implementation, DefaultRetryConfig()
  - Updated Table of Contents with Retry Logic subsection
  - Typecheck passed: `go build ./...`
- Files changed:
  - Modified: `docs/audits/architecture-comparison-report.md`
- **Learnings for future iterations:**
  - Retry logic is in `internal/api/retry.go` (not client.go)
  - Four categories of retryable errors: Backend Timeout, Gateway Errors (502/503/504), Network Errors, Kafka Transient
  - Default retry config: MaxRetries=3, MinDelay=10s, MaxDelay=60s
  - `doRequestWithRetry()` wraps `doRequest()` with `RetryWithBackoff()` for automatic retry handling
  - Conservative delays account for backend's internal Kafka Connect server retries
---

## 2026-01-21 - US-010
- What was implemented:
  - Ran `go test -v ./internal/helper/...` - all 10 tests passed with 50+ sub-tests (0.704s)
  - Added comprehensive "Helper Functions" section to `docs/audits/architecture-comparison-report.md`
  - Documented type conversion functions: GetTfCfgString, GetTfCfgInt64, GetTfCfgBool, GetTfCfgListString
  - Documented deprecated field migration function (MigrateDeprecatedValues)
  - Documented nil map safety handling for all helper functions
  - Updated Table of Contents with new section
  - Typecheck passed: `go build ./...`
- Files changed:
  - Modified: `docs/audits/architecture-comparison-report.md`
- **Learnings for future iterations:**
  - Helper functions are in `internal/helper/helper.go` (type conversion) and `internal/helper/deprecated.go` (migration)
  - GetTfCfgInt64 handles both float64 (JSON encoding) and string values
  - All helper functions return appropriate null/zero values for nil maps (safe defaults)
  - Test files: `internal/helper/helper_test.go` and `internal/helper/deprecated_test.go`
---

## 2026-01-21 - US-011
- What was implemented:
  - Read `internal/resource/connector/base.go` (701 lines)
  - Verified `modelToConfigMap()` function exists at lines 501-542 (reflection-based model → config map conversion)
  - Verified `configMapToModel()` function exists at lines 544-581 (reflection-based config map → model conversion)
  - Verified timeout context in all CRUD methods: Create (126-141), Update (325-340), Delete (434-449)
  - Verified import state passthrough at lines 496-499 using `resource.ImportStatePassthroughID`
  - Added comprehensive "Base Resource" section to `docs/audits/architecture-comparison-report.md`
  - Updated Table of Contents with new section
  - Typecheck passed: `go build ./...`
- Files changed:
  - Modified: `docs/audits/architecture-comparison-report.md`
- **Learnings for future iterations:**
  - Base resource implements 3 interfaces: resource.Resource, ResourceWithConfigure, ResourceWithImportState
  - Timeouts use `helper.DefaultCreateTimeout`, `helper.DefaultUpdateTimeout`, `helper.DefaultDeleteTimeout`
  - Type extraction handled by `extractTerraformValue()` (lines 583-628) supporting String, Int64, Bool, Float64, List
  - Type setting handled by `setTerraformValue()` (lines 630-666) using helper functions
  - String field helpers: `getStringField()` (669-686) and `setStringField()` (688-701) for ID/Name/Connector fields
---

## 2026-01-21 - US-012
- What was implemented:
  - Ran `go test -v -run 'TestSchemaBackwardsCompatibility' ./internal/provider/...` - all 16 tests passed (0.862s)
  - Verified no "required attribute removed" errors in any test
  - Verified no "optional changed to required" errors in any test
  - Added comprehensive "Schema Backward Compatibility Tests" section to `docs/audits/architecture-comparison-report.md`
  - Documented all 16 test results with baseline/current attribute counts
  - Documented that SQL Server source has 1 new additive attribute (backward-compatible)
  - Updated Table of Contents with new section
  - Typecheck passed: `go build ./...`
- Files changed:
  - Modified: `docs/audits/architecture-comparison-report.md`
- **Learnings for future iterations:**
  - Schema compatibility tests are in `internal/provider/schema_compat_test.go`
  - Tests compare baseline v2.1.18 schemas against current refactored schemas
  - Test naming: `TestSchemaBackwardsCompatibility_{Source|Destination|Transform}{ConnectorName}`
  - Tests verify 298 total attributes across 6 sources, 7 destinations, and 3 transforms
  - New additive attributes are allowed (INFO log), removed/changed-to-required attributes fail
---

## 2026-01-21 - US-013
- What was implemented:
  - Read `cmd/tfgen/deprecations.json` and counted 10 deprecated field entries
  - Spot-checked 2 PostgreSQL deprecated fields for proper DeprecationMessage (insert_static_key_field_1, insert_static_key_value_1)
  - Spot-checked Snowflake auto_schema_creation deprecation for proper DeprecationMessage
  - Added comprehensive "Deprecated Fields" section to `docs/audits/architecture-comparison-report.md`
  - Documented deprecations registry, field mappings, implementation architecture, and design characteristics
  - Updated Table of Contents with new section
  - Typecheck passed: `go build ./...`
- Files changed:
  - Modified: `docs/audits/architecture-comparison-report.md`
- **Learnings for future iterations:**
  - Deprecated fields are NOT in generated files (`internal/generated/`) - they're in wrapper files (`internal/resource/source/*_generated.go`, `internal/resource/destination/*_generated.go`)
  - Wrapper files add deprecated attributes via `GetSchema()` method which extends the generated schema
  - Deprecated and new attributes map to the SAME API field name (e.g., both `insert_static_key_field_1` and `transforms_insert_static_key1_static_field` map to `transforms.InsertStaticKey1.static.field`)
  - `deprecations.json` contains 10 entries: 9 PostgreSQL source, 1 Snowflake destination
---

## 2026-01-21 - US-014
- What was implemented:
  - Checked for STREAMKAP_CLIENT_ID and STREAMKAP_SECRET environment variables - both not set
  - Added comprehensive "Migration Tests" section to `docs/audits/architecture-comparison-report.md`
  - Documented status as SKIPPED due to missing credentials
  - Documented required environment variables and the command that would be run
  - Added "Workaround for Credential-less Verification" section referencing schema compatibility tests
  - Added recommendation for manual migration test execution before production release
  - Updated Table of Contents with new section
  - Typecheck passed: `go build ./...`
- Files changed:
  - Modified: `docs/audits/architecture-comparison-report.md`
- **Learnings for future iterations:**
  - Migration tests require TF_ACC=1, STREAMKAP_CLIENT_ID, and STREAMKAP_SECRET environment variables
  - Migration tests use the pattern `TestAcc.*Migration` for test discovery
  - Schema backward compatibility tests provide confidence even without credentials
  - Migration tests verify no unexpected plan changes when upgrading from v2.1.18 to refactored provider
---

## 2026-01-21 - US-015
- What was implemented:
  - Read `cmd/tfgen/parser.go` (429 lines) to verify code generator parser implementation
  - Verified `ParseConnectorConfig()` function reads `configuration.latest.json` format (lines 100-113)
  - Verified `user_defined: true` filter logic exists via `IsUserDefined()` (lines 117-119) and `UserDefinedEntries()` (lines 368-376)
  - Verified field metadata extraction: control (line 65), type (line 66), default (lines 163-241), required (lines 128-133)
  - Added comprehensive "Code Generator Parser" section to `docs/audits/architecture-comparison-report.md`
  - Updated Table of Contents with new section
  - Typecheck passed: `go build ./...`
- Files changed:
  - Modified: `docs/audits/architecture-comparison-report.md` (+223 lines)
- **Learnings for future iterations:**
  - Parser is in `cmd/tfgen/parser.go`, generator is in `cmd/tfgen/generator.go`
  - `ValueObject` struct (lines 63-81) contains all value-related metadata: control, type, default, raw_values, min/max/step
  - `TerraformType()` method (lines 245-264) maps backend controls to Terraform types (string→types.String, number→types.Int64, etc.)
  - `TerraformAttributeName()` method converts backend names to Terraform-friendly names (removes `.user.defined` suffix, replaces dots/hyphens with underscores)
  - Parser supports conditional fields via `Condition` struct and `IsConditional()` method
---
