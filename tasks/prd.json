{
  "project": "terraform-provider-streamkap",
  "branchName": "ralph/conditional-validation-struct-alignment",
  "description": "Conditional Validation and Struct Alignment - Fix Terraform schema conditional requirements to match backend validation rules, add missing deprecated field schema attributes, and fix struct/schema mismatches. IMPORTANT: Only use Opus 4.5 model for all tasks.",
  "userStories": [
    {
      "id": "US-001",
      "title": "Audit PostgreSQL source conditional fields",
      "description": "As a developer, I need to identify all conditional fields in PostgreSQL source backend config and compare with current Terraform schema.",
      "acceptanceCriteria": [
        "Read PostgreSQL backend configuration.latest.json",
        "Identify all fields with `conditions` array that have `required: true`",
        "Read current Terraform PostgreSQL source schema",
        "Document mismatches between backend conditions and Terraform Required status",
        "Create audit notes in progress.txt",
        "Typecheck passes: go build ./..."
      ],
      "priority": 1,
      "passes": true,
      "notes": "PostgreSQL schema ALREADY correctly implements conditional fields. Two required+conditional fields (signal_data_collection_schema_or_database, heartbeat_data_collection_schema_or_database) are correctly marked Optional with documentation. All deprecated fields have schema attributes with DeprecationMessage and field mappings."
    },
    {
      "id": "US-002",
      "title": "Update PostgreSQL source conditional fields",
      "description": "As a Terraform user, I want PostgreSQL conditional fields to be Optional when their conditions are not met.",
      "acceptanceCriteria": [
        "`signal_data_collection_schema_or_database` is Optional (required only when `snapshot_read_only=\"No\"`)",
        "`heartbeat_data_collection_schema_or_database` is Optional (required only when `heartbeat_enabled=true` AND `snapshot_read_only=\"No\"`)",
        "SSH fields (`ssh_host`, `ssh_port`, `ssh_user`) remain Optional (required only when `ssh_enabled=true`)",
        "Column include/exclude lists remain Optional based on `column_include_list_toggled` value",
        "Add sensible defaults where appropriate",
        "Typecheck passes: go build ./..."
      ],
      "priority": 2,
      "passes": true,
      "notes": "NO CHANGES NEEDED - All criteria already met in current schema. signal_data_collection_schema_or_database: Optional with default 'public'. heartbeat_data_collection_schema_or_database: Optional. SSH fields: all Optional with defaults. Column lists: Optional."
    },
    {
      "id": "US-003",
      "title": "Update MySQL source conditional fields",
      "description": "As a Terraform user, I want MySQL source conditional fields to match backend validation rules.",
      "acceptanceCriteria": [
        "Identify all conditional fields in MySQL backend config",
        "Update schema to make conditional fields Optional with appropriate defaults",
        "Heartbeat and signal table fields follow same pattern as PostgreSQL",
        "SSH fields conditional on `ssh_enabled`",
        "Existing configurations continue to work",
        "Typecheck passes: go build ./..."
      ],
      "priority": 3,
      "passes": true,
      "notes": "NO CHANGES NEEDED - MySQL schema already correctly implements conditional fields. signal_data_collection_schema_or_database: Optional. heartbeat_data_collection_schema_or_database: Optional with conditional requirement documented. SSH fields: all Optional with defaults."
    },
    {
      "id": "US-004",
      "title": "Update MongoDB source conditional fields",
      "description": "As a Terraform user, I want MongoDB source conditional fields to match backend validation rules.",
      "acceptanceCriteria": [
        "Identify all conditional fields in MongoDB backend config",
        "Update schema to make conditional fields Optional with appropriate defaults",
        "SSH fields conditional on `ssh_enabled`",
        "Existing configurations continue to work",
        "Typecheck passes: go build ./..."
      ],
      "priority": 4,
      "passes": true,
      "notes": "MongoDB schema already correctly implements conditional fields. signal_data_collection_schema_or_database: Required (backend has required:true with no conditions). SSH fields: all Optional with conditional requirement documented."
    },
    {
      "id": "US-005",
      "title": "Update DynamoDB source conditional fields",
      "description": "As a Terraform user, I want DynamoDB source conditional fields to match backend validation rules.",
      "acceptanceCriteria": [
        "Identify all conditional fields in DynamoDB backend config",
        "Update schema to make conditional fields Optional",
        "Typecheck passes: go build ./..."
      ],
      "priority": 5,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-006",
      "title": "Update SQL Server source conditional fields",
      "description": "As a Terraform user, I want SQL Server source conditional fields to match backend validation rules.",
      "acceptanceCriteria": [
        "Identify all conditional fields in SQL Server backend config",
        "Update schema to make conditional fields Optional",
        "Typecheck passes: go build ./..."
      ],
      "priority": 6,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-007",
      "title": "Update Kafka Direct source conditional fields",
      "description": "As a Terraform user, I want Kafka Direct source conditional fields to match backend validation rules.",
      "acceptanceCriteria": [
        "Identify all conditional fields in Kafka Direct backend config",
        "Update schema to make conditional fields Optional",
        "Typecheck passes: go build ./..."
      ],
      "priority": 7,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-008",
      "title": "Audit remaining source connectors for conditional fields",
      "description": "As a developer, I need to audit all remaining source connectors for conditional field requirements.",
      "acceptanceCriteria": [
        "Check Oracle, OracleAWS, MariaDB, DocumentDB source backend configs",
        "Check AlloyDB, Supabase, PlanetScale source backend configs",
        "Check Elasticsearch, Redis, Vitess, S3, Webhook, MongoDBHosted source backend configs",
        "Document all conditional fields found in progress.txt",
        "Typecheck passes: go build ./..."
      ],
      "priority": 8,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-009",
      "title": "Update AlloyDB, MariaDB, Supabase, PlanetScale source conditional fields",
      "description": "As a Terraform user, I want these MySQL-derived source connectors to have correct conditional fields.",
      "acceptanceCriteria": [
        "AlloyDB source conditional fields updated",
        "MariaDB source conditional fields updated",
        "Supabase source conditional fields updated",
        "PlanetScale source conditional fields updated",
        "Typecheck passes: go build ./..."
      ],
      "priority": 9,
      "passes": false,
      "notes": "These are PostgreSQL/MySQL derived, should follow similar patterns."
    },
    {
      "id": "US-010",
      "title": "Update Oracle, OracleAWS, DB2, DocumentDB source conditional fields",
      "description": "As a Terraform user, I want these source connectors to have correct conditional fields.",
      "acceptanceCriteria": [
        "Oracle source conditional fields updated",
        "OracleAWS source conditional fields updated",
        "DB2 source conditional fields updated",
        "DocumentDB source conditional fields updated",
        "Typecheck passes: go build ./..."
      ],
      "priority": 10,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-011",
      "title": "Update MongoDBHosted, Elasticsearch, Redis, Vitess, S3, Webhook source conditional fields",
      "description": "As a Terraform user, I want these source connectors to have correct conditional fields.",
      "acceptanceCriteria": [
        "MongoDBHosted source conditional fields updated",
        "Elasticsearch source conditional fields updated",
        "Redis source conditional fields updated",
        "Vitess source conditional fields updated",
        "S3 source conditional fields updated",
        "Webhook source conditional fields updated (if applicable)",
        "Typecheck passes: go build ./..."
      ],
      "priority": 11,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-012",
      "title": "Update Snowflake destination conditional fields",
      "description": "As a Terraform user, I want Snowflake destination conditional fields to match backend validation rules.",
      "acceptanceCriteria": [
        "Identify all conditional fields in Snowflake backend config",
        "`hard_delete` is Optional (conditional on `ingestion_mode`)",
        "Update schema to make conditional fields Optional",
        "Typecheck passes: go build ./..."
      ],
      "priority": 12,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-013",
      "title": "Update ClickHouse destination conditional fields",
      "description": "As a Terraform user, I want ClickHouse destination conditional fields to match backend validation rules.",
      "acceptanceCriteria": [
        "Identify all conditional fields in ClickHouse backend config",
        "`hard_delete` is Optional (conditional on `ingestion_mode`)",
        "Update schema to make conditional fields Optional",
        "Typecheck passes: go build ./..."
      ],
      "priority": 13,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-014",
      "title": "Audit and update remaining destination connectors conditional fields",
      "description": "As a developer, I need to audit and fix all remaining destination connectors for conditional fields.",
      "acceptanceCriteria": [
        "Databricks destination conditional fields updated",
        "PostgreSQL destination conditional fields updated",
        "S3 destination conditional fields updated",
        "Iceberg destination conditional fields updated",
        "Kafka destination conditional fields updated",
        "All other destinations audited and updated if needed",
        "Typecheck passes: go build ./..."
      ],
      "priority": 14,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-015",
      "title": "Add missing deprecated field schema attributes for PostgreSQL",
      "description": "As a Terraform user, I want deprecated fields to work with clear warnings.",
      "acceptanceCriteria": [
        "Add `insert_static_key_field_1` to schema with DeprecationMessage",
        "Add `insert_static_key_value_1` to schema with DeprecationMessage",
        "Add `insert_static_value_field_1` to schema with DeprecationMessage",
        "Add `insert_static_value_1` to schema with DeprecationMessage",
        "Add `insert_static_key_field_2` to schema with DeprecationMessage",
        "Add `insert_static_key_value_2` to schema with DeprecationMessage",
        "Add `insert_static_value_field_2` to schema with DeprecationMessage",
        "Add `insert_static_value_2` to schema with DeprecationMessage",
        "Add `predicates_istopictoenrich_pattern` to schema with DeprecationMessage",
        "Typecheck passes: go build ./..."
      ],
      "priority": 15,
      "passes": false,
      "notes": "These fields exist in struct but NOT in schema - violates Terraform Plugin Framework."
    },
    {
      "id": "US-016",
      "title": "Add field mappings for PostgreSQL deprecated fields",
      "description": "As a developer, I need to add field mappings for deprecated fields to work correctly.",
      "acceptanceCriteria": [
        "Add mapping for `insert_static_key_field_1` to API key",
        "Add mapping for `insert_static_key_value_1` to API key",
        "Add mapping for `insert_static_value_field_1` to API key",
        "Add mapping for `insert_static_value_1` to API key",
        "Add mapping for `insert_static_key_field_2` to API key",
        "Add mapping for `insert_static_key_value_2` to API key",
        "Add mapping for `insert_static_value_field_2` to API key",
        "Add mapping for `insert_static_value_2` to API key",
        "Add mapping for `predicates_istopictoenrich_pattern` to API key",
        "Typecheck passes: go build ./..."
      ],
      "priority": 16,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-017",
      "title": "Audit all connectors for struct/schema deprecated field mismatches",
      "description": "As a developer, I need to identify all connectors with deprecated struct fields missing from schema.",
      "acceptanceCriteria": [
        "Check all source connector structs for fields with `tfsdk` tags missing from schema",
        "Check all destination connector structs for fields with `tfsdk` tags missing from schema",
        "Document all mismatches in progress.txt",
        "Typecheck passes: go build ./..."
      ],
      "priority": 17,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-018",
      "title": "Fix deprecated field schema mismatches for other connectors",
      "description": "As a developer, I need to add missing schema attributes for all deprecated struct fields.",
      "acceptanceCriteria": [
        "All connector structs have matching schema attributes",
        "All deprecated fields have DeprecationMessage pointing to new field name",
        "All deprecated fields have field mappings",
        "Typecheck passes: go build ./..."
      ],
      "priority": 18,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-019",
      "title": "Fix Pipeline struct to include Timeouts field",
      "description": "As a Terraform user, I want Pipeline timeouts to work correctly.",
      "acceptanceCriteria": [
        "Add `Timeouts timeouts.Value` field to PipelineResourceModel struct",
        "Verify timeouts are properly read from config/state in CRUD methods",
        "Create, update, and delete timeouts all work correctly",
        "Typecheck passes: go build ./..."
      ],
      "priority": 19,
      "passes": false,
      "notes": "Schema has timeouts block but struct doesn't have Timeouts field."
    },
    {
      "id": "US-020",
      "title": "Audit all resources for struct/schema field mismatches",
      "description": "As a developer, I need to verify all resource structs match their schema declarations.",
      "acceptanceCriteria": [
        "Compare all source resource model structs against their schema definitions",
        "Compare all destination resource model structs against their schema definitions",
        "Compare transform and pipeline model structs against their schemas",
        "Document any mismatches in progress.txt",
        "Fix all mismatches found",
        "Typecheck passes: go build ./..."
      ],
      "priority": 20,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-021",
      "title": "Update tfgen parser to extract conditions array",
      "description": "As a developer, I want tfgen to parse conditional field requirements from backend configs.",
      "acceptanceCriteria": [
        "tfgen parser extracts `conditions` array from config entries",
        "Conditions data is stored in ConfigEntry struct",
        "Parser correctly identifies fields with conditions",
        "Typecheck passes: go build ./..."
      ],
      "priority": 21,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-022",
      "title": "Update tfgen generator to handle conditional fields",
      "description": "As a developer, I want tfgen to generate Optional attributes for conditional fields.",
      "acceptanceCriteria": [
        "tfgen generator marks conditional fields as Optional (not Required)",
        "tfgen adds appropriate defaults for conditional fields",
        "tfgen adds documentation noting when field is required",
        "Generated schemas compile correctly",
        "Typecheck passes: go build ./..."
      ],
      "priority": 22,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-023",
      "title": "Update tfgen to generate deprecated field schema attributes",
      "description": "As a developer, I want tfgen to generate schema attributes for deprecated fields in structs.",
      "acceptanceCriteria": [
        "tfgen reads deprecations.json and generates schema attributes for deprecated fields",
        "Generated deprecated fields have DeprecationMessage",
        "Generated deprecated fields have field mappings",
        "Typecheck passes: go build ./..."
      ],
      "priority": 23,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-024",
      "title": "Add validation tests for conditional fields",
      "description": "As a developer, I want tests verifying conditional validation logic works.",
      "acceptanceCriteria": [
        "Add unit tests for PostgreSQL conditional field validation",
        "Test that omitting conditional fields works when conditions not met",
        "Test that providing conditional fields works when conditions met",
        "Test that deprecated fields can still be used",
        "All tests pass",
        "Typecheck passes: go build ./..."
      ],
      "priority": 24,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-025",
      "title": "Update schema snapshots",
      "description": "As a developer, I need to update schema compatibility snapshots.",
      "acceptanceCriteria": [
        "Run UPDATE_SNAPSHOTS=1 go test -v -run 'TestSchemaBackwardsCompatibility' ./internal/provider/...",
        "Review snapshot changes to confirm they are expected",
        "Schema compatibility tests pass",
        "No unintended breaking changes introduced",
        "Typecheck passes: go build ./..."
      ],
      "priority": 25,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-026",
      "title": "Update documentation and examples",
      "description": "As a Terraform user, I want documentation reflecting conditional field requirements.",
      "acceptanceCriteria": [
        "Update example files to show conditional fields correctly",
        "Add comments explaining when conditional fields are required",
        "Update MIGRATION.md with deprecation guidance",
        "Run go generate to regenerate documentation",
        "Documentation accurately reflects schema",
        "Typecheck passes: go build ./..."
      ],
      "priority": 26,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-027",
      "title": "Final verification and cleanup",
      "description": "As a developer, I need to verify all changes work correctly together.",
      "acceptanceCriteria": [
        "go build ./... passes",
        "go test -v -short ./... passes",
        "Schema backward compatibility tests pass",
        "All deprecated fields work with deprecation warnings",
        "All conditional fields are Optional in schema",
        "All struct fields have matching schema attributes"
      ],
      "priority": 27,
      "passes": false,
      "notes": ""
    }
  ]
}
